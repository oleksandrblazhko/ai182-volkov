# WSTG - стабільний

## Тестування міжсайтового сценарію на основі DOM

## Резюме
Міжсайтовий сценарій на основі DOM — це фактична назва помилок XSS, які є результатом активного вмісту на стороні браузера на сторінці, зазвичай JavaScript, отримання введених даних користувача через джерело та використання їх у приймачі, що призводить до виконання введеного коду. У цьому документі розглядаються лише помилки JavaScript, які призводять до XSS.

DOM, або об’єктна модель документа, — це структурний формат, який використовується для представлення документів у браузері. DOM дозволяє динамічним сценаріям, таким як JavaScript, посилатися на такі компоненти документа, як поле форми або сеансовий файл cookie. DOM також використовується браузером для безпеки - наприклад, щоб обмежити сценарії в різних доменах від отримання сеансових файлів cookie для інших доменів. Уразливість XSS на основі DOM може виникнути, коли активний вміст, як-от функція JavaScript, змінюється спеціально створеним запитом, щоб елемент DOM міг контролювати зловмисник.

Не всі помилки XSS вимагають від зловмисника контролю над вмістом, що повертається із сервера, але натомість він може зловживати поганими методами кодування JavaScript для досягнення тих самих результатів. Наслідки такі ж, як і типовий недолік XSS, тільки засоби доставки відрізняються.

Порівняно з іншими типами вразливостей міжсайтових сценаріїв (відображених і збережених, коли сервер передає необроблений параметр, а потім повертає користувачеві та виконується в контексті веб-переглядача користувача), уразливість XSS на основі DOM контролює потік коду за допомогою елементів об’єктної моделі документа (DOM) разом із кодом, створеним зловмисником для зміни потоку.

Через свою природу вразливості XSS на основі DOM можуть бути виконані в багатьох випадках без можливості сервера визначити, що насправді виконується. Це може зробити багато загальних методів фільтрації та виявлення XSS неефективними для таких атак.

У цьому гіпотетичному прикладі використовується такий клієнтський код:

<сценарій><br>
document.write("Сайт знаходиться за адресою: " + document.location.href + ".");<br>
</script><br>

Зловмисник може додати #<script>alert('xss')</script> до URL-адреси ураженої сторінки, що під час виконання відобразить вікно сповіщення. У цьому випадку доданий код не буде надіслано на сервер, оскільки все після символу # браузер розглядає не як частину запиту, а як фрагмент. У цьому прикладі код негайно виконується, а на сторінці відображається сповіщення «xss». На відміну від більш поширених типів міжсайтового сценарію (відображеного та збереженого, у якому код надсилається на сервер, а потім назад у браузер, цей сценарій виконується безпосередньо в браузері користувача без звернення до сервера).

## Цілі тесту
-	Визначте поглиначі DOM.
-	Створюйте корисні навантаження, які стосуються кожного типу раковини.

## Як тестувати
Програми JavaScript суттєво відрізняються від інших типів програм, оскільки вони часто динамічно генеруються сервером. Щоб зрозуміти, який код виконується, веб-сайт, що тестується, потрібно просканувати, щоб визначити всі екземпляри JavaScript, які виконуються, і де приймається введення користувача. Багато веб-сайтів покладаються на великі бібліотеки функцій, які часто охоплюють сотні тисяч рядків коду й не розроблялися власними силами. У цих випадках низхідне тестування часто стає єдиним життєздатним варіантом, оскільки багато функцій нижнього рівня ніколи не використовуються, і їх аналіз, щоб визначити, які є поглиначами, займе більше часу, ніж зазвичай доступно. Те ж саме можна сказати про тестування зверху вниз, якщо вхідні дані або їх відсутність не ідентифіковано з самого початку.

Введення користувача здійснюється у двох основних формах:

-	Вхідні дані, записані на сторінку сервером у спосіб, який не дозволяє прямий XSS, і
-	Вхідні дані, отримані від клієнтських об’єктів JavaScript.

Ось два приклади того, як сервер може вставляти дані в JavaScript:

var data = "<екрановані дані з сервера>";<br>
var result = someFunction("<екрановані дані з сервера>");<br>
Ось два приклади введення з клієнтських об’єктів JavaScript:<br>

var data = window.location;<br>
var result = someFunction(window.referrer);<br>
Незважаючи на те, що код JavaScript не має великої різниці в тому, як вони витягуються, важливо зазначити, що коли вхідні дані надходять через сервер, сервер може застосувати будь-які зміни до даних, які йому потрібні. З іншого боку, перестановки, які виконуються об’єктами JavaScript, досить добре зрозумілі та задокументовані. Якби someFunction у наведеному вище прикладі була приймачем, тоді можливість використання в першому випадку залежала б від фільтрації, виконаної сервером, тоді як в останньому випадку це залежало б від кодування, виконаного браузером для об’єкта window.referrer. Стефано Ді Пауло написав чудову статтю про те, що повертають браузери, коли запитують про різні елементи URL-адреси за допомогою атрибутів документа та розташування.

Крім того, JavaScript часто виконується поза блоками <script>, про що свідчать численні вектори, які в минулому призводили до обходу фільтрів XSS. Під час сканування програми важливо звернути увагу на використання сценаріїв у таких місцях, як обробники подій і блоки CSS з атрибутами виразів. Крім того, зауважте, що будь-які об’єкти CSS або сценарії за межами сайту потрібно буде оцінити, щоб визначити, який код виконується.

Автоматизоване тестування має лише дуже обмежений успіх у ідентифікації та перевірці XSS на основі DOM, оскільки воно зазвичай ідентифікує XSS, надсилаючи певне корисне навантаження та намагаючись спостерігати його у відповіді сервера. Це може добре працювати для простого прикладу, поданого нижче, де параметр повідомлення відображається назад до користувача:

<сценарій><br>
var pos=document.URL.indexOf("message=")+5;<br>
document.write(document.URL.substring(pos,document.URL.length));<br>
</script><br>
Однак його можна не виявити в наступному надуманому випадку:

<сценарій><br>
var navAgt = navigator.userAgent;<br>

if (navAgt.indexOf("MSIE")!=-1) {<br>
        document.write("Ви використовуєте IE як браузер і відвідуєте сайт: " + document.location.href + ".");<br>
}<br>
інше<br>
{<br>
    document.write("Ви використовуєте невідомий браузер.");<br>
}<br>
</script><br>
  
З цієї причини автоматичне тестування не виявить області, які можуть бути чутливими до XSS на основі DOM, якщо інструмент тестування не зможе виконати додатковий аналіз коду на стороні клієнта. Таким чином, слід провести ручне тестування, яке можна здійснити шляхом вивчення областей коду, де згадуються параметри, які можуть бути корисними для зловмисника. Приклади таких областей включають місця, де код динамічно записується на сторінку та інші місця, де DOM змінюється, або навіть де безпосередньо виконуються сценарії.

## Санація
Щоб дізнатися про заходи щодо запобігання XSS на основі DOM, перегляньте шпаргалку щодо запобігання XSS на основі DOM.
